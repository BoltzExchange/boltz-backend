use crate::{chain::types::Type, wallet::Network};
use alloy::hex;
use bitcoin::ScriptBuf;
use bitcoin::secp256k1::PublicKey;
use elements::hex::ToHex;
use elements::pset::serialize::Serialize;
use lightning::util::ser::Writeable;

#[derive(Hash, Eq, PartialEq, Debug, Clone)]
pub struct Outpoint {
    pub hash: Vec<u8>,
    pub vout: u32,
}

#[derive(PartialEq, Debug, Clone)]
pub enum Transaction {
    Bitcoin(bitcoin::Transaction),
    Elements(elements::Transaction),
}

pub fn encode_address(
    address_type: Type,
    script_pubkey: Vec<u8>,
    blinding_pubkey: Option<Vec<u8>>,
    network: Network,
) -> anyhow::Result<String> {
    match address_type {
        Type::Bitcoin => {
            let script_buf = ScriptBuf::from_bytes(script_pubkey);
            Ok(bitcoin::Address::from_script(&script_buf, network.bitcoin())?.to_string())
        }
        Type::Elements => {
            let pubkey = blinding_pubkey
                .map(|b| PublicKey::from_slice(b.as_ref()))
                .transpose()?;
            let script = elements::Script::from(script_pubkey);
            let addr = elements::Address::from_script(&script, pubkey, network.liquid()?).ok_or(
                anyhow::anyhow!("failed to parse liquid script: {:?}", script.to_hex()),
            )?;
            Ok(addr.to_string())
        }
    }
}

impl Transaction {
    pub fn txid_hex(&self) -> String {
        match self {
            Transaction::Bitcoin(tx) => tx.compute_txid().to_hex(),
            Transaction::Elements(tx) => tx.txid().to_hex(),
        }
    }

    pub fn serialize(&self) -> Vec<u8> {
        match self {
            Transaction::Bitcoin(tx) => tx.serialize(),
            Transaction::Elements(tx) => tx.serialize(),
        }
    }

    pub fn input_outpoints(&self) -> Vec<Outpoint> {
        match self {
            Transaction::Bitcoin(tx) => tx
                .input
                .iter()
                .map(|i| Outpoint {
                    vout: i.previous_output.vout,
                    hash: i.previous_output.txid.encode(),
                })
                .collect(),
            Transaction::Elements(tx) => tx
                .input
                .iter()
                .map(|i| Outpoint {
                    vout: i.previous_output.vout,
                    hash: i.previous_output.txid[..].to_vec(),
                })
                .collect(),
        }
    }

    pub fn output_script_pubkeys(&self) -> Vec<Vec<u8>> {
        match self {
            Transaction::Bitcoin(tx) => tx
                .output
                .iter()
                .map(|o| o.script_pubkey.to_bytes())
                .collect(),
            Transaction::Elements(tx) => tx
                .output
                .iter()
                .filter(|o| !o.script_pubkey.is_empty())
                .map(|o| o.script_pubkey.to_bytes())
                .collect(),
        }
    }
}

pub fn parse_transaction_hex(
    transaction_type: &Type,
    transaction: &str,
) -> anyhow::Result<Transaction> {
    parse_transaction(transaction_type, &hex::decode(transaction)?)
}

pub fn parse_transaction(
    transaction_type: &Type,
    transaction: &[u8],
) -> anyhow::Result<Transaction> {
    match transaction_type {
        Type::Bitcoin => {
            let tx = bitcoin::consensus::deserialize(transaction)?;
            Ok(Transaction::Bitcoin(tx))
        }
        Type::Elements => {
            let tx = elements::encode::deserialize(transaction)?;
            Ok(Transaction::Elements(tx))
        }
    }
}

#[cfg(test)]
mod test {
    use crate::chain::types::Type;
    use crate::chain::utils::{Outpoint, Transaction, parse_transaction_hex};
    use alloy::hex;

    #[test]
    fn test_parse_transaction_bitcoin() {
        let hex = "0200000000010103645fa5850fa5800a87b2a8c79b9326c81c0efe3ad487a6aade4f9fc57578550100000000fdffffff02406f40010000000022512060b5cba1e3a0577877cd2978dfc4d859c0f8e6a5f627c93ef339d3f886fe52e7e7575a3a00000000225120bb7beca2338aeaa5cf8237c3106b63a70bfebb8ced05f82c7ccc399ba815da610247304402205bf0c42957549cac99a3fab2a562090ea2b7aff0612efbdd38877b2327523a69022074781677c7e25d3632bfaec4cc350c4624db73e3d91ed9bf02f24ccd856bc582012103fbc5c2e836f3d7a088214b265b6afafa3186852d95032ed0d122e5b96d74997791000000";
        let tx = parse_transaction_hex(&Type::Bitcoin, hex).unwrap();

        assert_eq!(tx.serialize(), hex::decode(hex).unwrap());

        assert_eq!(tx.input_outpoints().len(), 1);
        let mut input_id =
            hex::decode("557875c59f4fdeaaa687d43afe0e1cc826939bc7a8b2870a80a50f85a55f6403")
                .unwrap();
        input_id.reverse();
        assert_eq!(
            tx.input_outpoints(),
            vec![Outpoint {
                hash: input_id,
                vout: 1
            }]
        );

        assert_eq!(tx.output_script_pubkeys().len(), 2);
        assert_eq!(
            tx.output_script_pubkeys(),
            vec![
                hex::decode("512060b5cba1e3a0577877cd2978dfc4d859c0f8e6a5f627c93ef339d3f886fe52e7")
                    .unwrap(),
                hex::decode("5120bb7beca2338aeaa5cf8237c3106b63a70bfebb8ced05f82c7ccc399ba815da61")
                    .unwrap()
            ]
        );

        assert!(matches!(tx, Transaction::Bitcoin(_)));
    }

    #[test]
    fn test_parse_transaction_elements() {
        let hex = "020000000101f56af7c29b7a0f7f065e9f47b8e836c832544c89c80037162a88b231a75f5d570000000000fdffffff030ae2d7a7c99060828e596ce2ac67fd80f3bc2e47c3ca32415d51db69c9cdc7cd5e08d7bca95e93846a1815340db2a04f94661c6e18eeb0245f27642baf8b9c72fa2102c0d58fd658459eb33623f26a0c01d5480f62d71081afef35a22d792398edce72160014a3ab45d87ce4e48d817692d1920d0158d3cbde5d0b6664be92bf16f957f32464b9e7de92d0a1395191785854c07ee4a6e5b1fd15090932c0d93db9bc29aabcceceb7e647204b9b53cbc57dd2c6d6be57ac67435e8f74021f3564aca097ac5c82e5ef73d6a4424770de59d1028d86c6a5398882efaf730d1600145aac09643b7db5a46d6a5b6c381187fcd3d0bc0d0125b251070e29ca19043cf33ccd7324e2ddab03ecc4ae0b5e77c4fc0e5cf6c95a0100000000000000190000680000000000024730440220492afff6ce6b5b8badf4b277839fd0aa8b8742e6e29a1997ca3cdf1e89367b690220695b7d724d970f579edfee2b653e2877d0ec894dd187598f8a1766a8c6bb39130121035cac2efe8b4643045f0a9f540283b5ae0788e7c149ddbd615f1e74c72844f3b200430100011b59a27fee8ab9d0986fe6daedf20a0162ba911ceac5b8a4c2dcb3c9e54a58bd89690f8f9768791f41d375ad6a887caa67b75d8e1ca250aa511c3d2deb37b56dfd4e1060330000000000000001e3381f00c851e81773c8f3bc28d451572f65c64ebdbbcef7bc9d5d6615dd14184ba65514bd06f24706035b8bbbd7b3a5c5ec8ee3b4982c568d8076d2f06d7d149d33de89099da1ae42132f4309fe723bcca312b1302679cb3ee2165be72596a3b816dbf4d67f42fb29dc10dc70017e12094a4c495ba821fe36d5df206af0104d13587aac4abcfe70501e186a9a33f11fb59ffb363e938956f111f71d705405083362cc8b5f4a0bbb9d86f8801dd851b949d807b34fc29e9aaab24236bc31317419c1ba0348ed5ae10d0cbe32da82961d15e5cd2688577406ad9bb3607225bbfe4b41b85dbbbf131d97b78f781f80b548fc58344a5c435e0871df7cb8d11088e0d78622818a7902dd74ba82a7789c4a52eaf47c4d094b5ad0a23d62bb52219f77595b3142b6cc76fd2e4bfc2ea0a7df7c9e06da15d1c0e91f0a83ba087b791c8e4dcd5d5aaa9caeee516a4dcc01d62d9e14cd575796a1e488b72ac3f74ae05d8e55b385e20cd903cfbc22a754750d48971009d7c7e4679d65d8d96f84c3ba949b291864c85eb1d4faff72e4be67ebbaedc66e2bfcea8fd6fc87a95373cb86c9b722fd4a2bdcf7d964f397c5494608fcd9d8a0e7e6403526e22702119e5201bf878b7f7f01f3a45a88d993211872afff9f2f89670cb4fb6c0fc5a140bd67d1373ab8e4ba4de8f2a3a3d25e536da2fcb9ed1dbcfabb7e26fab7e40bc8febdf776bb813dc97216313137f16e7274352e9551a5f32ae9607e80dc0c3eafe8d1153bbd18dd3330a6be53dab636ea94375bdb1405c6cdbbb0e26fee3f104c6828f6b443a5f2aee4883a7fd290488694c6825fea9a372070a33a4e68a3c9dc2ecd2fbe6a62b325eab6e049dd264fd48e1b93d2e3eb3d4ea6dc4027349d4d8dcc32415d6cdf0f4f0c3c9eaa581e44e47c054e25945aa902a516d0cba1a2bc5d504eb26774eb09479276e60a1774fdfa89ad2b7861c5beca8df4d9ac01bfb08c6986408f5d62105dc2ee26af5a1ec39c301795e48da2be1561c2a06b5acfa29d38f2ecd141941738f111fcacf5a4e67a52b2d9e312885ea6f6fce32a045dbf6e5bc8f16571f9f2f5319da119102fab96da7b08066f742b7ea2921df3a20a9e1c94ecc3859ebfe53ab03e1bb677b52688f7367bc078edc0d8f2f65df13d44b47272a4ae15925e17928cf6262eee5e577338667d5ca41921eedaa5928c81f6e98ff881197c038f418d0ef1332051fb925884baa28ba16bdefce60859200803744158d254f9132f0818e4b38b16f73ee39db4f12e1b4f9de12360703dc00d199e362f29a6469bf11a32c35f1c0a2befbde3104ad683551046f6f72ccf3191f26edff9f40e7cc6f51449eed95dc0be49385a747b2b4c49c1f7981e112cfdf586feb875261465f8e27473614695c71694b1a1e5d52213cee5dc1883e4b30818c1c22d9252a20c0c73f450e0ee7221cddac25dc3bca58b21b14c5c918a122412ba9571ad447ebe663936523f83f5ad94fb72c909c5a35963dce7ad47731c73fd1fbd8f31cde2579c7f6f818ff0e5c8a2bc1584ac1455936b43fde5be36f153fe01593df07ddfd3aac5e234906ebf2fe6b2990e36a809285e81310a2c7232420dcadceb84f78233e7e69a8f144a4dbe54c12af4f586d5f78e71d6e758a4b51d1e254fb546aa5ce6ae328e23797a81e0ccfbad89f48cdd86107bb3069f518b17e51555c561d585af90dd818b6f454c59ede35b65aab43ef251a70b2ac6d0fd86a777c3ee53da5fb4d67885a4fae12294bad97188e48f92bf25c4c645262d6d4878a529edbf76618f672a104c0cf7c14c963a0345f5e73ad4974704a6ac5583465eb67ee478c9178fe0c3f5e1c398ce0f0a7e0fd8afc13f7659d4ef64bb5d835b56e423a7ef199f0fc4d0ed3d6012d04df00ad8c664141e6cbf8e45a4187267fbb3002778efd48a0cfe53764d0dd6c46ec8116c654c83b5f8f8299b73dc1f631650f0dd70cbdb5e954c55b14f6e5fc4e02e47fc04364ab50a5938b9f34e5fcf5f4f99c89c8d685dea935b210da4d72c09a908ce13d172c3a78d39b2a657736d7143a9f01c8da23a9e1d0464c0227c4c12157348002fee7770e5d0ae057509cc4e395604b8b56b23078e5062ab7354c9652a954de41838db2015aa72f19bd17d66c2574efb2e02a5395f02b4665e7e275d7689c8fc3f35cc5ef522ac49e9d26897dc3f88ea53e94a53f4d6557fb68cf73fdf04b7944d3cae42d5691351e53d27a2bf5ee51da3f53088c3ab125ea4f97d5b6fada7d697a22518a4c3330c3746018f94ce55e5f77d404173e27c7f5bf5179d1631ad61eeab39db5736cc1d7d8dea5588d7b6870b34e6e83e7b25bcf9400bb3cbe4d413e44769155464d07ce799d2b612018f2bb3eb0b338b2984f375a18a30564c6f47fb653498a29ef90994b7727324373f86ef49ebd02d777c87d7a605d1827833584dd83009fdcb6d893e6e9b87b001e39dbdfc10412c2f4788016b72b5dbb32e65b48e649f776899f7d84f9c80f7be737f15bafb3c9af8bc81877399aa19a68a91217c293274a46295aa2e143ca5d7dba6fab1c7b7371267affe7de5e8725d42fc48addf2078b187754f8f35961963109cc6d8c99ba6885b7c3377b2ccea957ae9ce40e5c44caaff9282d64bcb5ea635ebce016da1115897410044be816f0af66e9de0eafa7ca84a8a9073a1c97e9dc4a824d98e7d42f537ac1bbe7c6160d648882bcd35c61e45c69e6d4b7043cd7d42d1d73aced885fdd59e4a9a372ca50c45277d8bbfd7951e81b645244f48f53573b9525b9855223cffca101233631d87b9ed304ed4c99851fb0bfecec3a49d4e25e8d16f4624aef6d0d433ae5ca04a1e580b62ac0aa1df2f53c62a80003c08c58c4bc1709f48457bd097ae7196a1b7045bed6e1feef172828821361f4d50c4bd48d0e4067d3e7e1486da4540954f49a335e36db2d66e1b95554752a6e99ba7060ade208b09bc0481d42cee61dff8c61822cd9bad821d63745a2c020c65db1671ead3ab23ac2adea94863e087e7d11a4777c57332d5f7c393230f4c2352158b46689d71053a8802e611efdabe063e405d6a9569a7a9f2c485de55d24777215ed2afc749b3183f95a24af78c37bec6ab040bba98829274e27c8486fd7781b62c25e2814b17ee3966e1932e3b3cfa2051353a4ed813690e29fbfb0865d9e33c12c5643324896dc300e203c5a03f4998ff6edbc418d313fcd0beefeea43a8690fc0f03f6433fbf8029db4faba3369929cf9f67bd3ba0a3c7679ec2531edbf7718b65e9899faffabf14d92f5d3f0cea7e8bd068f048a35c094e697c8b6c2329fd014cb9c627f5b432d09a0e27ff04fa9b31ac051e4cdd45170d4f21a3f93dccfeeb2e56c83c55f695575479f883eab7d317c242f699ff4015fe187a7e7509fd3dc7949a8a2e310ea117f4138ad41e2a4e30d0ca53e9167144c49f787983cf1d97d1c3fc761a8321b31d4a22bc9805210ac364fcdb0f09e289444db798682e262427cdd6ed73479c363a1cf06b4b3ba6081d56123b33b6c3962b59d509225259715fdd765a7c1a1e2425c800c12e851365b03da3aeda55cc2da932701df5c247427a48ada7f91c889b4657de8743154fcadb2070621e7e2bff06476260a742ed22855f7efac37ae1adcd25dadb2110a72271a5d58728a7271ab6b2f57820ae2ec8a9836cf85f8122f0198d822788c85971941f903ec4479e7e95b0642229a00c46c23540659f99e9b49479385a4b7dd5ea5346dc6ae6f3dd1b93526ecc0513f72884017b0aa72ceda287058e32ad63725e7f91fea0054250f57186eb87d7017f63c84403859bdb9b50d17845d98077d5987af427ee129d52efaf3fe0afdc71d3038db6c3c267724a0429991911f37bd7d65f2d95da51982f7b37a6624cf8ec918e14c6718a2dca897c40a2f7fea443c41c9aa40e892b5f9a849367ea4ab13aa5e8e38bfacef75f348f4f0de51ae67d2970157981ed9257569b8e1b92173ad221ad7d5021e2d6f926989ee315f0d1291a2d5f2bedd5cb199f33b0e32a6cab707db3aba80b2eef6af9b0f6570b611854d9cf1a2a31c2e17e6d817800eaf275b1c155a62581cdc940eec6b454ac6936ef6c8ff2c4cfb74cae3760bcb8ef8fda5ee3cdce7b491dcd1c193a769943e54c7e3a9282d7217e8603fd27db39b61572534ae5cecd552b29e721fadf8196d4c25efdf8ab570cae629daf3904465c7440ab5b6a8a784619b5c07e37b00fe666616f62b10b8c86e1077b3b3fcb4fe6722b0cdb370a98530426ae0c9ffe629b8123ddba710b234ace3e1b2eb581b62e4e76417b0837233bf03de881426430a63e5d7e3306df139caa268156d49fcee42c4efeaa4530ea5c4b811bbc87ec90f75527f479581495c17c72de37952fd9b0a1b6650cd20c703fa8c484c718007f36261bd90509c5e965cff9100f9360973f664b5f489fa16b16612809e3c46253daa6b6789f85652548d2d1a6cfdb6cf8c983937f67877de7e81ff0a6e476c09866c06fa5a6d2199466e8d967f145b4bd6ec76982a1ece1663b5ce42460289f6d041b42d7efaa18f1a8006ed7cbe738b0e0e8ee6ea4190bf3faefa86f8a9f4a348a35ba5332b3186523ddc2844a829cb05a53f925ffe8b02d4b0e0aa6820a48d39ef60071424edf5b1d633a362cb538cc15e471af228dad3b73a0fb771081d525aa8fe6151c7f01b343334662721a8e66bf6ab02ae5e7c93467fc911bc705f25bf5893d2ad792b54a8b47277753c8c9eab50a7d7b91ff867bf5c09a631a04e6811586cfb22f155e8349900f226cb7a97ccd82fb922f7069da36131fc77936f519802ad87892c135c9d9a3efba70c1e930a69f12aaa92bd4d72f3f0f0cb6ef1bfc3697bafe3aefb51b335676512797578f6123ab5b69d078c050aed6aa3c8fe37917bf5c638714b01fb37db5c506f46d3dd6649393ec5d175b9050e14cc9c37b5dbb6928b984de64f40c3eb0818f1e0c3714c92589d40409b5be6bfe2fdec23a7ab4e2d6478226c49181823818a4814449b4aa9a596d426e3c2deee9d8ffa2ad8f5ea8bab35a4310015ade4a48fe63aa465bb7ae755be1851e48b4ea2f4c9c13025bcf90ba23f6dfbce89638c6797a6909f8a4d311d0265a8a0815418a8f10fa3f98d174aaf6fd1f45c8703f19702e7d0f3cd26bc67e74692b363c08fe6925148ee5997f8ae0768ab68c187028a98f831d7f170cac8a59aa2cd9c725c38b0ca83c5640edc10ebc798861a5f3b6f8d9f897afb4114643e635c3c60522842db2a40e363b6bce887c13bb3a518a77cc2ee46b51f0232e4b3e1efe9aa0e6f29ab36a3dae5e9de4478af677e146f58c018b03505161e25951930fe9b184502dcdc510b04ab54f658677d7700a2fbdcea7687a318b5e584a8b5e9d99e820228851fec6c0f7d6b5f682eb497d1ddab7a4420d79e1fce024350936305c196458c61942664f771805ba78c3649955fd94b976240f3ba3cccbf3063330886d190b3244f01b02c09ac7f266348407ed73b1bad27e4d22693f845cadacc6246980026cbd71996f8a2e812d3c3a150e010c46185f0d9407fe063726c19c4ab335747d94c32313be8c30b8ad6281415f133b0da633d034ba96312122541238ee6b37acfa3dd824d4d0cfc9010022a1ea89a760b82d3a8a6458f395323c0216d507a4c3f8b66d5cf577c50890169a86c5930959e37afd5ade9c21be553a8550458a517a30bb53e631f3b199c8882290b7d7d8f5ea0c753d1b324f0b504c53a59d430ae082f479996ecb594e24dfa161f638b861853d5730db9f613684dfd239fd12e1dd6ab005f74314638e30ff53004aaa16dfa92f535efe227b10b10f86f1b1ca940b505682f92dfbab1043010001f606c4887b50408b66604a2242e2fcb72d73402722a4e17b1c75ac78011f757eb974712a9ee38ac8db06938cc73c63b30894b808af7a61ffa011c7e44e797daefd4e106033000000000000000117ad9900488d85ead27d6b508b90414ff9406c4dc36ce3723704b123fce4c17f73b663ba9993914eef78b04c7bf77ca22daa6d2031e4a2f033d235a16c81327faa54bfbf182f40cf92a07adb56626e1380f8fd6d6591be841c714611ba607afcc5d2f8e99484618f82ec1cb8d96bda8b2eaa1776a259b58df160dbd7da1593540b969878b5f4ba4384c57ac69d69e2d753d574cf8e2a466356f667b6468e1e5b6eb7f462632fb4a9dcedd8097681994ec3d3a7b18861b8ef62cd15e6472204b6131fe502f029d37a14593c7afdccc6077e32894b19a5fe973a6bc34ac08d9406879fe4478ae0a334ace25d6a9a22298c2f8594627dd4582e41be7bd16c2d6eda0975ce51e21dec275bea115562f967c79f0db1832ebd1984c36c56a1ae183e3816570ecdc292ec3c9b6a080ee93237ffa20a3f0cdd6dc07425c57ed27cb157e1c3264d96149fac3d05c7a3286c441a14b5fe3f2986d1d2a298cb80afb61fea499854be0ce0582a5f390a839cfb8cd0ad87f1054e4d8daeb1116513d6b45727eda6ab4014ed80d5935ebbdd581159de4014d0467622ad859e823311630d076dc32db234fce90c94af0e6921e6223f047a3b3da8c45024d2ba5b7284441c494be66a8eb5ab76499b2d3b13302df7ab9685dad735a127a6b220d7723c48d074bb29675dd774d3ff669f45d004781f37b2a015b9fa81aa1aa4594c86c0aec0370ee4d2d0e4ceb944aaf2e565aadaa1d22d2c78a1c8df17858590d7c3da0b8871f61c4852b29f23581853d728ebfcb845e7d47d376932c7b96e0ac98ac2933948baeaf34754dd19069c0cbec8304aa8570241b79d19fe0ddbfdd91da0389462324442159c9f3f1da51b63f7e15761463ab3d20b26a02fb998ec1fba25bc0c80c074d82e6b8e4fb197f655f146cb7557fd64a74aa1c8eeb3f1433822c700bf4e827ecaa6ffdec0bc1cf0329fb65e829c3f423e9394cc8f51053c17b01a53b543bfba2452253c9fe8832e216ba8de03c6c4be25a2bbf113bd94f18d5d3dca4f04e733647d7da8e188c545174589d63233683fe6533c4194586b2d5eea3bfc00bd202127fbaec00d4a6dd90edfa71e788d336b515f5a01cd806a2803078a8908b8337ed50dda21de1101352fdbab91aebb6d1ad2d8551fac44c1dbc3e4af908eddd51b2ce8ea570a4e3574045ca4949ef108f7a3fbc2dbf24451b70d845578436f680d5a29160bb2480539c6288561f3d3cfebd2070128fc323d96c75c0a758748b262d669034c61e5e32a3d127631db62f29263d530f4d61430a8c4a2941c1f1d75d5290f1cfe45b5e976e4654ea9e9088ed03c399e2949c6cf7556ff0a73e4e102b5d0e549e9c54976721fa5fbca985c42c490b3ad3c99554bd5883ba92d9c39555e680e25918011c479be1f1288243c16e37faf7499a7cbc9733ee1d2023a99bb4379915c1415a5cef57e87f9fb36961a19f970201432ef3870ba5698777c56e9bf0159d1aab35bf275089582b92622b9112ecb9b58119c6c802aee1612bf078fd1d5357dfc6de700e33b0043bc671728bee22302099241dec86606509c303ae2fbf515177d64d44367c110495ab8fc3e1716ad3faae92a40bcb13cae0f9b69513d8840a35864d512f6d65c002c639ba288c218db21860404f2e7539c98bba7de4a46d040ab1ac667f41546ce81597fa85068526fc31470cf17bec0d7be610ba720138028e9f17aef18ca8868d390b9a5bfe1208cf497fbbc97cadf2b1ecf8ef9b36463373586cb25e435826844fdd8a29f8c25f3b55f365e40f6a33a68c1f8e6fe08821f7842008cf675348240271ed08bb73ffc2cf5e2dd4f9d33435e7c1a078a61bee7c0def8a261a52379449a6e4b6e3ca240efb8cc36cbaa604afac3ea0186a1752c697ebf7509c733f1d983b7a0e7c3b66fabd2056e11b2cb3032da162128f730877f7156b194e750eb3ee0f2920f7549ccca3e108c653afff200ba452370e0e86f7f297d31678181a139ea89696c626e04697a6c59de2cb02bf58e77cd96e3c6d9feb3a070de830b8f3b17e37ac13ff290eb10e337eaf69b3f224dbe31319b0818ab81bc1898ca4b32fdc0f9ce3bcb479c0150efb12df0e338f1745638d7a3d95c038255dc0376e96138437f396bc5a07010d4b34d3b076f455313d26f64d8b467755b1438aea869a3ecc1f79e8cc61e0f2041352ecbfebab3a979925933a63062f6f923ecb006c684517a6b92bfcdff3e811be941c089c6784092a0944a637af0577622548378ebd032d18ee1453ec8cf4bd20432d429127933c5abf2b8da7fd61c318be1def63c0f1d1fcede524b3e1d3a4a9feea0f1f7a304ae40121a0abc9582e571de105bcc75d14cb6906054aae86779eece7168dae179a05c90a4ae0de7d7bf5a3d19a27fc0b08b7c2372c87962f2cdebe4e1d6809f456b7dab7dc9c2d4e36df01216deb843ef352f1bb3167777737e4efd5e4751f31a707065ee26a063c4146378299221f530747c5f0746ab04e0af2b9dca257e23221e8317039684f6e3fd4ffc063d9d197e0e42a211fd248827ef5f913fd45af5acf2f6d57a72fdd9e7f35996228ea8ed88f423e139c9baf2ce816a3858636e03fcc2433cee312179f17629a4f9a3ede759806fdb4497839671a10ac81f51a41aca3d0b7cd87e942c7831418e65b3b57e6b0b88c7b9b50b445bff925e6d85da4cc0397e4169bc4cba287f04c493b2ba0ebffd2a54595510e12854f9db270484b5244ed69b2718ffaedc20d013654f048f34fb1ee9ea2e6ceeba1483fb4b46786ad2f8eaf8da994aee5bd81976bd1954604b500e94bebd34725702b6129e14bb89e4083808630f99b5098b74f9b6ba4af07d29fbc97cdaea8260f38ca8e4977885453f9bbcaf2a48cac0b49b067b832940f548e1aa678d90d17d3a860b27e137ccb81fba206b796d4c7388dda66a760f97a5b521d03ef166f7302fd727f36817b31575c136d789dabc09430ae8bd38d80d5b3df931af025e5df639367dd548dfcb5ca64f3c267a626472e53e0bd74f8288272f97d3ac035ec0a335e9deb9fc22a744107158794d83657fe355dd85b43c8b1ba00c890525e43c2c961e0522c9d3f2d473f2eaef12f2abece9b282307d3d877be5bc8fd2140dd810265109a54d1ed4c051372776cac7fc563818ea8f130792dd56383c0f113933f9b861f71ea872b6fd129de8e13d64c1f201dbfa2ee26e72ef600d8c79ace340f952c7f9820f313b3fec044e14b4511923d272d7034253b4577081beacec66a77e609d3eee0d33d9c8d1c63d31948cae024a3d4c93c396f81ec1103472e202c20fd7a05119c94eaa39a403f639c4835bd2cf158c2d3289d7829f0a543147767ca06a64265b548f2c81ae1ae96f5cb3540440f7a46226125ea3606e385427b1333e286078ed05357cd46ea54fa5954730cc5a6c6db62d191356839596fb4d139549014ab5b58e6f60779a05120f4e00de8b9477e130716d15597106f2129b0911d63952a54be5bfa4816e818bd3cdb23be59739ec550c02638f989e2a2ef2eddc659955ceb445ac7f7b7dd3bea14f6f204b2e77edf4b917068edbbe5a302b8183b266fc1c3cdb1efc5a6ea81a754fc6329f36386d648c00ac59c8ce2a0bc585ea5b8391aeb15a79cc660c971d11520bc6a460a8a966d7195730a21caad326c9ac12dcd6d3b4f12f73b6f56d1649044502bfb00a88d32f13da027b2365eea9e298fb3f1c9d05d17051aa9b11185b3d748ab67f539fbc422c55bebebbc93ec24afae1c930200f9960366b5fa7b9ac109aa3312d2315add74eb479cb41b66371258220ce943139c42a34424cbb71204aafb2d59562db978238dedf26f026f63cc6d3a4e1f521c581e8818d13c128703cb39e483293016eafecf7f0e959724ea0fad9e50be3c05a2478a47dc06d54a8ae9816a2530669c10848fe91827f9ab15e4353f499eff5359e89413cadee40567da1c1f3c2e18e69f821701bb45c3df68ff18125644045623a8cae63cd1496e7c01db01e1615cc79d7a908ecb3182cd82f39da09548aad0602dae4b758921897cfa5452f34a1989367d6a1985c7549dd0d1f63a52f1a97d0df53f5b496614fad1cc4c3b4685f2545b27b0476bcec25f1de2ddac6730e1ee89f2edd017c36f72e73da28c12b294e90b672509c134e1cbc68dc89f33061afddabc405f866f77c21d1e85e1c847997cf5d6d4e4b98c43bda6240030d36249845d2d439fbe33e78438e60fe9a1fcbbc168b0a900ab1729c3cc17ebb337df98de31c509bcb3924eee9e3a543ae55ab7ef8836f7dc327b47cbb16fbb20007f3eccf2ef629f06623c2ad803c6a8a0b47d0f46c8473209bcda50095cb2c762f28a6af6cb260c7aae3954b1e84baac519822c77d1e4e2373b0f45a277d36f3eff3e12ae8ceeebad62d88c319a4ef1898bd53e4965dd509f5b79911193a91338d1cfac0b859e414d6ce98bca2476f62e65fdad724eaf93010a0f2d0d08683451823842f7cadd8b296ac6eb8f9f4cfda2373c6d9045599f7c4cd8bef2b0526d8479f920041aba2395f24e29bb208feffe60871319f2909bda05c6d58dacd9f72ca4b15de3535b436e7c9172c6f38030f7b906f1568c602974c9ec3283339157868a197101c2ed054e07d2b35b47f30536d003f74a180a957ac8cdb348303f62ed5547630ccdc846b3a435d834a2272f8b152e412dcd104c9f67b43874571294a1d767559d65fa6ab3fac59e283f667a7d4aab9f44894008ab615011f9aa322c05edbd56ff65658097f172a42e810fc284a58564d45f2f642940687c3236358545a17d98c4e80eca70ec84137a38bc6a41225fb2e36cc294f4fe5091c14d764bf7d2f9ef9d1f4f02a556bbc6841e9887e02db23dfdfa5f9b7799268a87de4f6b6100f412c92a56aab3e93b4e5127fc019271bf74af83e3ebdd72c609da55f7e792d2ba8379fa566f9fe9bf3bd1e831f83bba610449a200f1ed5243117f571a78fa36d289c4c96add601e7beead7f2a29b0b0021c54f0bb5fbce86ac83e6578889a061bc3f8f077d8777d4ee66f28392f4a344a2a624148a7902c34ce33c7e9708fa2f0c03031957b0562a7081a675db39ffd409bcb43b2612fd2f00dce1233727f57288586316cd07f2ac015a16f417911faa979c5f4803b9cd96d9e842e3c23b05d83929b0b7b140d433ab6b78aabfc85688361938ddf4bf71b0a9ebebff27c71380b1d940f7290174fd308b56dd9463ba8706e20b3b7ef97bc6bad9dd29f54b0870402da57115568953b14fdf488a57776abdb9abb67edfffd2b599268b91bad878c674eacf1b75e5a43d35f75222c9a5fedcb0eed76400a6be49e367de530330c0b961a33bee47d4efcb08a103a5ecbbd59ec4d923659e823eb620f1d1790d8a60b68bd76e1c893673751b41084c48373b7da0a4ddfb9c968076a71ab57805c470170fcb25800ec833499304dff6856c171b7ee80620e538ba7ee974e7159cb12015420338b3cef7b9e2ba9d8adffd6785b444605db66433f5b77a0248115f1283e73c2c3229911faea87643c4b7c3af5e3f2ed6778b9a34d1a65f6952ab709664854db3ab01e8e1065f93a66b89d9dc4b0e4082ee83fcbf7d04e151c31085dba52af2e9527262d4bbbd4616c8b820a4fc1d71925cbf77c781e98faf2b0bfac2f9787121d45f0b5428194035a2c21336a3b22ced4cd190e0b0d38c8d4f50ad92f3a31ca29e4d0691a6528b584995a01b5be6e3abe723f3a89f88144dd864b5fd469da77c1906acad194b1ae850fa026decb4b2359a8d6655a84916f6e868c3260326658ba837971c1a82b1aae801aaf2c76a69ea6ac1c0ab2713f8add78d177dc31734bf7af1850c1a0e220e935ab48d0000";
        let tx = parse_transaction_hex(&Type::Elements, hex).unwrap();

        assert_eq!(tx.serialize(), hex::decode(hex).unwrap());

        assert_eq!(tx.input_outpoints().len(), 1);
        let mut input_id =
            hex::decode("575d5fa731b2882a163700c8894c5432c836e8b8479f5e067f0f7a9bc2f76af5")
                .unwrap();
        input_id.reverse();
        assert_eq!(
            tx.input_outpoints(),
            vec![Outpoint {
                vout: 0,
                hash: input_id,
            }]
        );

        assert_eq!(tx.output_script_pubkeys().len(), 2);
        assert_eq!(
            tx.output_script_pubkeys(),
            vec![
                hex::decode("0014a3ab45d87ce4e48d817692d1920d0158d3cbde5d").unwrap(),
                hex::decode("00145aac09643b7db5a46d6a5b6c381187fcd3d0bc0d").unwrap()
            ]
        );

        assert!(matches!(tx, Transaction::Elements(_)));
    }
}
